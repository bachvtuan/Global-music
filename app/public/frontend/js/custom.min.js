var sortable_app=angular.module("html5.sortable",[]);sortable_app.directive("htmlSortable",function($parse,$timeout,$log,$window){return{restrict:"A",require:"?ngModel",scope:{htmlSortable:"=",ngModel:"=",ngExtraSortable:"="},link:function(scope,element,attrs,ngModel){var sortable={};sortable.is_handle=!1,sortable.in_use=!1,sortable.handleDragStart=function(e){return $window.drag_source=null,$window.drag_source_extra=null,sortable.options&&!sortable.is_handle&&sortable.options.handle?void e.preventDefault():(sortable.is_handle=!1,e.dataTransfer.effectAllowed="move","IE"!=sortable.browser&&e.dataTransfer.setData("text/plain","anything"),$window.drag_source=this,$window.drag_source_extra=element.extra_data,void this.classList.add("moving"))},sortable.handleDragOver=function(e){e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",this.classList.contains("over")||this.classList.add("over")},sortable.handleDragEnter=function(){this.classList.contains("over")||this.classList.add("over")},sortable.handleDragLeave=function(){this.classList.remove("over")},sortable.handleDrop=function(e){if(e.stopPropagation&&e.stopPropagation(),e.preventDefault(),this.classList.remove("over"),$window.drag_source!=this){if(null==$window.drag_source)return void $log.info("Invalid sortable");var source_model=$window.drag_source.model,drop_index=this.index;if(-1!=ngModel.$modelValue.indexOf(source_model)){var drag_index=$window.drag_source.index,temp=angular.copy(ngModel.$modelValue[drag_index]);sortable.unbind(),ngModel.$modelValue.splice(drag_index,1),ngModel.$modelValue.splice(drop_index,0,temp)}else{if(!sortable.options.allow_cross)return void $log.info("disabled cross dropping");ngModel.$modelValue.splice(drop_index,0,source_model)}scope.$apply(),sortable.options&&angular.isDefined(sortable.options.stop)&&($log.info("Make callback"),sortable.options.stop(ngModel.$modelValue,drop_index,element.extra_data,$window.drag_source_extra))}return!1},sortable.handleDragEnd=function(){[].forEach.call(sortable.cols_,function(col){col.classList.remove("over"),col.classList.remove("moving")})},sortable.unbind=function(){$log.info("Unbind sortable"),[].forEach.call(sortable.cols_,function(col){col.removeAttribute("draggable"),col.removeEventListener("dragstart",sortable.handleDragStart,!1),col.removeEventListener("dragenter",sortable.handleDragEnter,!1),col.removeEventListener("dragover",sortable.handleDragOver,!1),col.removeEventListener("dragleave",sortable.handleDragLeave,!1),col.removeEventListener("drop",sortable.handleDrop,!1),col.removeEventListener("dragend",sortable.handleDragEnd,!1)}),sortable.in_use=!1},sortable.activehandle=function(){sortable.is_handle=!0},sortable.register_drop=function(element_children){element_children.addEventListener("drop",sortable.handleDrop,!1),element_children.addEventListener("dragstart",sortable.handleDragStart,!1),element_children.addEventListener("dragenter",sortable.handleDragEnter,!1),element_children.addEventListener("dragover",sortable.handleDragOver,!1),element_children.addEventListener("dragleave",sortable.handleDragLeave,!1),element_children.addEventListener("drop",sortable.handleDrop,!1),element_children.addEventListener("dragend",sortable.handleDragEnd,!1)},sortable.getBrowser=function(){var browser_agent=$window.navigator.userAgent;return-1!=browser_agent.indexOf(".NET")?"IE":-1!=browser_agent.indexOf("Firefox")?"Firefox":"Chrome"},sortable.update=function(){$log.info("Update sortable"),$window.drag_source=null;var index=0;return 0==ngModel.$modelValue.length?void(element[0].children.length>0&&(element[0].children[0].index=0,sortable.register_drop(element[0].children[0]))):(this.browser=this.getBrowser(),this.cols_=element[0].children,[].forEach.call(this.cols_,function(col){if(sortable.options&&sortable.options.handle){var handle=col.querySelectorAll(sortable.options.handle)[0];handle.addEventListener("mousedown",sortable.activehandle,!1)}col.index=index,col.model=ngModel.$modelValue[index],index++,col.setAttribute("draggable","true"),sortable.register_drop(col)}),void(sortable.in_use=!0))},ngModel?ngModel.$render=function(){$timeout(function(){sortable.first_load=!1,scope.$watch("ngExtraSortable",function(value){element.extra_data=value}),scope.$watch("htmlSortable",function(value){return sortable.options=angular.copy(value),"destroy"==value?void(sortable.in_use&&(sortable.unbind(),sortable.in_use=!1)):(angular.isDefined(sortable.options)||(sortable.options={}),angular.isDefined(sortable.options.allow_cross)||(sortable.options.allow_cross=!1),angular.isDefined(sortable.options.construct)&&sortable.options.construct(ngModel.$modelValue),element[0].classList.add("html5-sortable"),sortable.update(),void $timeout(function(){sortable.first_load=!0}))},!0),scope.$watch("ngModel",function(){sortable.first_load&&"destroy"!=sortable.options&&$timeout(function(){sortable.update()})},!0)})}:$log.info("Missing ng-model in template")}}});
var app=angular.module("app",["ngRoute","ngCookies","ngResource","ngAnimate","usersApp","albumApp","linkApp","playerApp","songApp","navigationApp","headerApp"]);app.run(function($rootScope,$window,$http,$cookies,$dialogs,$location,$templateCache){$templateCache.put("loading.html",'<div class="wrap-loader"><p class="inline link"><i class="fa fa-circle-o-notch fa-spin"></i>&nbsp; {{text}}</p></div>'),$rootScope.processRetrieveData=function(res,callback,callback_error){if("error"==res.status){var message=res.data;angular.isDefined(callback_error)?callback_error(message):$dialogs.error(message)}else callback(res.data)},$rootScope.mediaLink=function(media_id){return"/media/"+media_id},$rootScope.addContextClass=function($event){var parent=$($event.target).parents(".wrap-context");log($event),log($($event.target)),$(window).height()-$event.pageY<420?parent.addClass("dropup"):parent.removeClass("dropup")},$rootScope.convertToSizeString=function(byte_number){var mega_byte=byte_number/1024/1024,return_string=1e3*mega_byte;return return_string+"kb"},$rootScope.removeItemInList=function(list,id){for(var i=0;i<list.length;i++)if(list[i]._id==id){list.splice(i,1);break}},$rootScope.updateScopeObject=function(scope_object,data,remove_old_properties){var new_key=[];remove_old_properties=angular.isDefined(remove_old_properties)?remove_old_properties:!0;for(var key in data)new_key.push(key),scope_object[key]=data[key];if(remove_old_properties)for(var key in scope_object)-1==new_key.indexOf(key)&&delete scope_object[key]},$rootScope.updateItemInList=function(list,new_item){for(var updated=!1,i=0;i<list.length;i++)if(list[i]._id==new_item._id){$rootScope.updateScopeObject(list[i],new_item),updated=!0;break}return updated},$rootScope.templateVersion=function(template_url){return $window.templateVersion(template_url)},$rootScope.navigation_template=$rootScope.templateVersion("frontend/js/navigation/navigation.html"),$rootScope.header_template=$rootScope.templateVersion("frontend/js/header/header.html"),$rootScope.song_template=$rootScope.templateVersion("frontend/js/song/song.html")});
var app=angular.module("app");app.factory("$dialogs",function($rootScope,$window){return{notify:function(message,type,delay){delay=angular.isDefined(delay)?delay:10;var org_delay=$window.alertify.get("notifier","delay");$window.alertify.set("notifier","delay",delay),$window.alertify.notify(message,type),$window.alertify.set("notifier","delay",org_delay)},message:function(message,delay){return this.notify(message,"notify",delay)},success:function(message,delay){return this.notify(message,"success",delay)},error:function(message,delay){return this.notify(message,"error",delay)},dismissAll:function(){$window.alertify.dismissAll()},confirm:function(title,callback){$window.alertify.confirm(title).setting("onok",function(){$rootScope.$apply(function(){callback()})})}}}),app.factory("fSharedService",function($rootScope){var sharedService={};return sharedService.message=null,sharedService.prepForBroadcast=function(msg){this.message=msg,this.broadcastItem()},sharedService.broadcastItem=function(){$rootScope.$broadcast("handleBroadcast")},sharedService}),app.factory("Page",function($rootScope){return{title:function(){return $rootScope.page_title},setTitle:function(newTitle){$rootScope.page_title=newTitle}}}),app.factory("Net",function($q){return{isImage:function(src){var deferred=$q.defer(),image=new Image;return image.onerror=function(){deferred.resolve(!1)},image.onload=function(){deferred.resolve(!0)},image.src=src,deferred.promise}}});
app.directive("focusMe",function($timeout,$parse){return{link:function(scope,element,attrs){var model=$parse(attrs.focusMe);scope.$watch(model,function(value){value===!0&&$timeout(function(){element[0].focus()})}),element.bind("blur",function(){})}}}),app.directive("loadImage",function(){return{restrict:"EA",scope:{source:"=","class":"="},template:"<img />",link:function(scope,iElement,iAttrs){var class_=angular.isDefined(iAttrs.extraClass)?iAttrs.extraClass:"";scope.$watch("source",function(value){var img=iElement.find("img");img.attr("src",value),""!=class_&&(img[0].className+=" "+class_)},!0)}}}),app.directive("loadAudio",function(){return{restrict:"EA",scope:{source:"="},template:"<audio />",link:function(scope,iElement){scope.$watch("source",function(value){var audio=iElement.find("audio");audio.attr("src",value)},!0)}}}),app.directive("ngTooltip",function(){return{restrict:"A",link:function(scope,element,attrs){scope.$watch("title",function(value){attrs.$set("tooltip",value),attrs.$set("data-toggle","tooltip"),$(element).tooltip()})}}}),app.directive("disableAnimate",function($animate){return{restrict:"A",link:function(scope,element){$animate.enabled(!1,element)}}}),app.directive("avatar",function($parse,$rootScope,$compile){var image_template='<img class="avatar" />',linker=function(scope,element,iAttrs){var class_=angular.isDefined(iAttrs.extraClass)?iAttrs.extraClass:"";scope.$watch("extraId",function(value){element.html(image_template).show();var img=element.find("img"),avatar_url="/frontend/images/logo.png";if(angular.isDefined(value)&&null!=value&&(avatar_url="/media/"+value),img.attr("src",avatar_url),""!=class_){var imgs=element.find("img");imgs.length>0&&(imgs[0].className+=" "+class_)}$compile(element.contents())(scope)},!0)},result={restrict:"EA",rep1ace:!0,scope:{extraId:"=","class":"="},link:linker};return result});
function log(){if(is_debug)for(var i=0;i<arguments.length;i++)console.log(arguments[i])}function warn(message){is_debug&&console.warn(message)}function log_table(object){is_debug&&console.table(object)}function error(message){is_debug&&console.error(message)}function templateVersion(path){var seperate_arr=path.split("/");return seperate_arr.length>2&&(seperate_arr.splice(seperate_arr.length-1,0,"templates",template_version_string),path=seperate_arr.join("/")),path+timeStampParam()}function prependTemplateUrl(prefix_url){return"api/{0}/{1}".format(templateVersion_string,prefix_url)}function timeStamp(){return(new Date).getTime()}function timeStampParam(){var addtional_url="?version="+asset_version;return"undefined"==typeof window.begin_time_stamp&&(window.begin_time_stamp=timeStamp()),is_debug?addtional_url+"&time="+window.begin_time_stamp:addtional_url}function convertKeyProps(list,arr_input_keys,arr_output_keys){for(var arr_return=[],i=0;i<list.length;i++){for(var obj={},j=0;j<arr_input_keys.length;j++)obj[arr_output_keys[j]]=list[i][arr_input_keys[j]];arr_return.push(obj)}return arr_return}function roundNumber(number,decimal_points){if(!decimal_points)return Math.round(number);if(0==number){for(var decimals="",i=0;decimal_points>i;i++)decimals+="0";return"0."+decimals}var exponent=Math.pow(10,decimal_points),num=Math.round(number*exponent).toString();return num.slice(0,-1*decimal_points)+"."+num.slice(-1*decimal_points)}function UUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}function removeUnicode(str,sepereate){return sepereate="undefined"==typeof sepereate?" ":sepereate,str=str.toLowerCase(),str=str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),str=str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),str=str.replace(/ì|í|ị|ỉ|ĩ/g,"i"),str=str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),str=str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),str=str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),str=str.replace(/đ/g,"d"),str=str.replace(/!|@|\$|%|\^|\*|\(|\)|\+|\=|\<|\>|\?|\/|,|\.|\:|\'| |\"|\&|\#|\[|\]|~/g,sepereate),str=str.replace(/-+-/g,sepereate),str=str.replace(/^\ +|\-+$/g,"")}String.prototype.format||(String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return"undefined"!=typeof args[number]?args[number]:match})}),alertify.defaults={modal:!0,movable:!0,resizable:!0,closable:!0,maximizable:!0,pinnable:!0,pinned:!0,padding:!0,overflow:!0,maintainFocus:!0,transition:"pulse",notifier:{delay:5,position:"bottom-right"},glossary:{title:"Music app",ok:"OK",cancel:"Cancel"},theme:{input:"ajs-input",ok:"ajs-ok",cancel:"ajs-cancel"}};
var usersApp=angular.module("usersApp",[]);usersApp.factory("Users",["$resource","$cookies",function($resource){return $resource("users/:tail",{},{query:{method:"GET"},post:{method:"POST",headers:{"x-csrf-token":csrf}},update:{method:"PUT",headers:{"x-csrf-token":csrf}},remove:{method:"DELETE",headers:{"x-csrf-token":csrf}}})}]),usersApp.config(["$routeProvider",function($routeProvider){$routeProvider.when("/login",{templateUrl:templateVersion("frontend/js/users/login.html"),controller:"LoginCtrl"}).when("/register",{templateUrl:templateVersion("frontend/js/users/register.html"),controller:"RegisterCtrl"}).when("/forgot-password",{templateUrl:templateVersion("frontend/js/users/forgot.html"),controller:"ForgotPasswordCtrl"}).when("/logout",{templateUrl:templateVersion("frontend/js/users/logout.html"),controller:"LogoutCtrl"}).when("/edit-profile",{templateUrl:templateVersion("frontend/js/users/setting.html"),controller:"UserSettingCtrl"}).otherwise({redirectTo:"/login"})}]);
usersApp.factory("$userStyle",function($rootScope,$cookieStore,Users,$location,$window){var bg_list={"default":{local:"frontend/images/backgrounds/sunset.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/sunset_zps486cf1d1.jpg"},"brown-wood":{local:"frontend/images/backgrounds/brown-wood.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/brown-wood_zpsbb30d864.jpg"},yellow:{local:"frontend/images/backgrounds/yellow.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/yellow_zps0da7361c.jpg"},violate:{local:"frontend/images/backgrounds/violate.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/yellow_zps0da7361c.jpg"},sunny:{local:"frontend/images/backgrounds/sunny.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/sunny_zps7827daf3.jpg"},sailfish:{local:"frontend/images/backgrounds/sailfish.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/sailfish_zps268c75fc.jpg"},ocean:{local:"frontend/images/backgrounds/ocean.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/ocean_zpsa9f02910.jpg"},night:{local:"frontend/images/backgrounds/night.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/night_zpsb3a6df17.jpg"},nexus:{local:"frontend/images/backgrounds/nexus.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/nexus_zps079a9211.jpg"},lights:{local:"frontend/images/backgrounds/lights.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/lights_zps2e638494.jpg"},kiwi:{local:"frontend/images/backgrounds/kiwi.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/kiwi_zps0e182b28.jpg"},greenish:{local:"frontend/images/backgrounds/greenish.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/greenish_zpsaf4e4548.jpg"},city:{local:"frontend/images/backgrounds/city.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/city_zps184b5d1d.jpg"},chrome:{local:"frontend/images/backgrounds/chrome.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/chrome_zps3c080fc3.jpg"},blue:{local:"frontend/images/backgrounds/blue.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/blue_zpsdfe8c01f.jpg"},tectile:{local:"frontend/images/backgrounds/tectile.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/tectile_zps9e5a5892.png"},cloth:{local:"frontend/images/backgrounds/cloth.jpg",server:"http://i1105.photobucket.com/albums/h360/bvtuan/background/cloth_zps443c66b1.png"}},get_full_background=function(_class){var obj=bg_list[_class];return"url('{0}')".format($window.is_debug?obj.local:obj.server)},list=[{name:"Default","class":"default",preview:"frontend/images/backgrounds/thumb-sunset.jpg",style:{"background-image":get_full_background("default")}},{name:"Brown wood","class":"brown-wood",preview:"frontend/images/backgrounds/brown-wood.jpg",style:{"background-attachment":"initial","background-size":"initial","background-image":get_full_background("brown-wood")}},{name:"yellow","class":"yellow",preview:"frontend/images/backgrounds/thumb-yellow.jpg",style:{"background-image":get_full_background("yellow")}},{name:"violate","class":"violate",preview:"frontend/images/backgrounds/thumb-violate.jpg",style:{"background-image":get_full_background("violate")}},{name:"sunny","class":"sunny",preview:"frontend/images/backgrounds/thumb-sunny.jpg",style:{"background-image":get_full_background("sunny")}},{name:"sailfish","class":"sailfish",preview:"frontend/images/backgrounds/thumb-sailfish.jpg",style:{"background-image":get_full_background("sailfish")}},{name:"ocean","class":"ocean",preview:"frontend/images/backgrounds/thumb-ocean.jpg",style:{"background-image":get_full_background("ocean")}},{name:"night","class":"night",preview:"frontend/images/backgrounds/thumb-night.jpg",style:{"background-image":get_full_background("night")}},{name:"nexus","class":"nexus",preview:"frontend/images/backgrounds/thumb-nexus.jpg",style:{"background-image":get_full_background("nexus")}},{name:"lights","class":"lights",preview:"frontend/images/backgrounds/thumb-lights.jpg",style:{"background-image":get_full_background("lights")}},{name:"kiwi","class":"kiwi",preview:"frontend/images/backgrounds/thumb-kiwi.jpg",style:{"background-image":get_full_background("kiwi")}},{name:"greenish","class":"greenish",preview:"frontend/images/backgrounds/thumb-greenish.jpg",style:{"background-image":get_full_background("greenish")}},{name:"city","class":"city",preview:"frontend/images/backgrounds/thumb-city.jpg",style:{"background-image":get_full_background("city")}},{name:"chrome","class":"chrome",preview:"frontend/images/backgrounds/thumb-chrome.jpg",style:{"background-image":get_full_background("chrome")}},{name:"blue","class":"blue",preview:"frontend/images/backgrounds/thumb-blue.jpg",style:{"background-image":get_full_background("blue")}},{name:"tectile","class":"tectile",preview:"frontend/images/backgrounds/tectile.png",style:{"background-image":get_full_background("tectile"),"background-size":"inherit"}},{name:"cloth","class":"cloth",preview:"frontend/images/backgrounds/cloth.png",style:{"background-image":get_full_background("cloth"),"background-size":"inherit"}}];return{setUser:function(user){$rootScope.user=user,$cookieStore.put("user",user)},setUserAlbum:function(user_album){$rootScope.user_album=user_album},getUser:function(is_redirect){var user=$rootScope.user;if(is_redirect=angular.isDefined(is_redirect)?is_redirect:!1,user||(user=$cookieStore.get("user")),!user){if(log("not found user information at cookie"),!is_redirect)return null;$location.path("/login")}return user},getList:function(){return list},get:function(name){return _.find(list,function(style){return style.name==name})},getUserStyle:function(){var user=this.getUser();if(user){angular.isDefined(user.theme)||(log("Set as default theme to cookie"),user.theme="Default",$cookieStore.put("user",user));var theme=this.get(user.theme);return log("theme is",theme,user.theme),theme?theme:this.get("Default")}return this.get($rootScope.user_album&&$rootScope.user_album.theme?$rootScope.user_album.theme:"Default")},setUserStyle:function(style_name){var user=this.getUser(!0);user.theme=style_name;var current_fac=this;Users.update({tail:"update",action:"extra"},user,function(res){$rootScope.processRetrieveData(res,function(data){$rootScope.user=data,$cookieStore.put("user",data),log("theme is updated"),current_fac.setBodyStyle()})})},getBodyStyle:function(){var style=angular.copy(this.getUserStyle());return $rootScope.current_album&&$rootScope.current_album.wallpaper_url&&(style.style["background-image"]="url('{0}')".format($rootScope.current_album.wallpaper_url)),style.style},setBodyStyle:function(){$rootScope.body_style=this.getBodyStyle()}}});
usersApp.controller("LoginCtrl",function($scope,$http,$location,$window,Users,$dialogs,$location,$cookieStore,$rootScope,$userStyle,Page){$scope.init=function(){$scope.pending_login=!1,$scope.resetValue(),Page.setTitle("Login to app"),Users.get({tail:"info"},function(res){if(log(res),"ok"==res.status){var user=res.data;$scope.redirectDashboard(user)}})},$scope.redirectDashboard=function(user){$cookieStore.put("user",user),$rootScope.user=user,$userStyle.setBodyStyle(),$location.path("/albums")},$scope.resetValue=function(){$scope.login_name="",$scope.password=""},$scope.checkValid=function(){return""!=$scope.login_name&&""!=$scope.password},$scope.submit=function(){var post_data={login_name:$scope.login_name,password:$scope.password};$scope.pending_login=!0,Users.post({tail:"login"},post_data,function(res){$scope.pending_login=!1,$scope.processRetrieveData(res,function(data){$dialogs.success("successful :Your login information is accepted"),$scope.redirectDashboard(data)})})}});
usersApp.controller("LogoutCtrl",function($scope,$http,$location,$window,Users){$scope.init=function(){Users.post({tail:"logout"},{},function(res){$scope.processRetrieveData(res,function(){$location.path("/login")})})}});
usersApp.controller("RegisterCtrl",function($scope,$rootScope,$http,$location,$window,Users,$dialogs,Page,$location,$cookieStore,$userStyle){$scope.init=function(){Page.setTitle("Register new account"),$scope.pending_register=!1,$scope.resetValue()},$scope.resetValue=function(){$scope.user_name="",$scope.email="",$scope.password="",$scope.repeat_password=""},$scope.checkValid=function(){return""==$scope.user_name?!1:""==$scope.email?!1:""==$scope.password||$scope.password!=$scope.repeat_password?!1:!0},$scope.submit=function(){log("submit","here");var post_data={user_name:$scope.user_name,email:$scope.email,password:$scope.password};$scope.pending_register=!0,Users.post({tail:"register"},post_data,function(res){$scope.pending_register=!1,$scope.processRetrieveData(res,function(data){$scope.user_name="",$scope.resetValue(),$dialogs.message("success :Please check your email for activation, The email may take about 1 minute to arrive"),$cookieStore.put("user",data),$rootScope.user=data,$userStyle.setBodyStyle(),$location.path("/albums")})})}});
usersApp.controller("UserSettingCtrl",function($scope,$rootScope,$http,$location,$window,Users,$dialogs,$userStyle,Page,Net){$scope.init=function(){$scope.maximum_file_upload=$window.maximum_file_upload,Page.setTitle("Edit your setting"),$scope.current_tab="general",$scope.$userStyle=$userStyle,$scope.user=$userStyle.getUser(),$scope.edit_user=angular.copy($scope.user),log("$scope.edit_user 2",$scope.edit_user),$scope.list_style=$userStyle.getList(),$scope.current_style=$userStyle.getUserStyle()},$scope.setStyle=function(style){log(style),$scope.current_style=style,$userStyle.setUserStyle(style.name)},$scope.updateBasic=function(){$scope.working_basic=!0;var post_data=angular.copy($scope.edit_user);Users.update({tail:"update",action:"update_basic"},post_data,function(res){$scope.working_basic=!1,$scope.processRetrieveData(res,function(data){$userStyle.setUser(data),$dialogs.success("Your basic information have been changed")})})},$scope.updatePassword=function(){if(!$scope.current_password)return $dialogs.error("Please input your current password");if(!$scope.new_password)return $dialogs.error("Please input new password");if(!$scope.confirm_password)return $dialogs.error("Please confirm password");if($scope.confirm_password!=$scope.new_password)return $dialogs.error("The new password doesn't match with the confirm password");if($scope.current_password==$scope.new_password)return $dialogs.error("The new password is duplicated with your current password");log("Great, let change the password");var post_data={current_password:$scope.current_password,new_password:$scope.new_password};$scope.working_password=!0,Users.update({tail:"update",action:"change_password"},post_data,function(res){$scope.working_password=!1,$scope.processRetrieveData(res,function(){$scope.current_password="",$scope.new_password="",$scope.confirm_password="",$dialogs.success("Your password have been changed")})})},$scope.updateCurrentAvatar=function(){{var extra=$avatar_list.getValue($scope.edit_user["info:user_name"]);prependTemplateUrl("users/avatar/")+$scope.edit_user["info:user_name"]+"/"+extra}},$scope.updatePreview=function(){Net.isImage($scope.new_avatar_url).then(function(result){result&&(log("updatePreview",$scope.new_avatar_url),$("#preview-avatar").attr("src",$scope.new_avatar_url))})},$scope.readURL=function(input){if(input.files&&input.files[0]){var reader=($(input).val(),new FileReader);reader.readAsDataURL(input.files[0]),$scope.addEventHandler(reader,"loadend",function(e){var result=e.target.result;if(e.total>$scope.maximum_file_upload){var alert_string="Please select an image has capacity below "+$scope.convertToSizeString(maximum_file_upload);return $dialogs.error(alert_string)}var checking_image_pattern="data:image/";return result.substr(0,checking_image_pattern.length)!=checking_image_pattern?$dialogs.error("Please select an image file"):void $("#preview-avatar").attr("src",result)})}},$scope.addEventHandler=function(obj,evt,handler){obj.addEventListener?obj.addEventListener(evt,handler,!1):obj.attachEvent?obj.attachEvent("on"+evt,handler):obj["on"+evt]=handler},$scope.uploadAvatar=function(){var src=$("#preview-avatar").attr("src");return angular.isDefined(src)?($scope.working_avatar=!0,void Users.update({tail:"update",action:"change_avatar"},{src:src},function(res){$scope.working_avatar=!1,$scope.processRetrieveData(res,function(data){$userStyle.setUser(data),$scope.user=data,$scope.new_avatar_url="",$("#preview-avatar").removeAttr("src"),$dialogs.success("Success","Your avatar is updated")})})):$dialogs.error("Please select image file before upload")}});
usersApp.controller("ForgotPasswordCtrl",function($scope,$http,$location,$window,Users,$dialogs){$scope.init=function(){$scope.login_name=""},$scope.checkValid=function(){return""!=$.trim($scope.login_name)},$scope.submit=function(){log("login_name",$scope.login_name),$scope.pending_forgot=!0,Users.post({tail:"reset-password"},{login_name:$scope.login_name},function(res){$scope.pending_forgot=!1,$scope.processRetrieveData(res,function(){$scope.login_name="",$dialogs.success("Please check your email for reset new password")})})}});
var albumApp=angular.module("albumApp",[]);albumApp.config(["$routeProvider",function($routeProvider){$routeProvider.when("/albums",{templateUrl:templateVersion("frontend/js/album/album.html"),controller:"AlbumCtrl"}).when("/albums/:type",{templateUrl:templateVersion("frontend/js/album/album.html"),controller:"AlbumCtrl"}).when("/album/:album_id",{templateUrl:templateVersion("frontend/js/album/album.html"),controller:"AlbumCtrl"})}]),albumApp.factory("Albums",["$resource","$cookies",function($resource){return $resource("albums/:tail",{},{query:{method:"GET"},post:{method:"POST",headers:{"x-csrf-token":csrf}},update:{method:"PUT",headers:{"x-csrf-token":csrf}},remove:{method:"DELETE",headers:{"x-csrf-token":csrf}}})}]),albumApp.controller("AlbumCtrl",function($scope,$http,$location,$window,$dialogs,$rootScope,Albums,$timeout,$routeParams,Page,fSharedService,$userStyle){$scope.init=function(){$scope.pending_add_album=!1,$scope.resetValue(),$scope.albums=null,$scope.select_album_id=null,$scope.type=$routeParams.type,$scope.search_albums=null;var get_params={};$routeParams.album_id&&($scope.share_album_id=$routeParams.album_id,get_params.id=$routeParams.album_id),"public"==$scope.type&&($scope.filter_album="!",$scope.navigation_name="public_album"),$scope.navigation_name=get_params.id?"share_album":"album",Page.setTitle("Browse album"),Albums.get(get_params,function(res){$scope.processRetrieveData(res,function(data){if(log("Data",data),data=_.sortBy(data,function(album){return album.created_date}),$scope.albums=data,$scope.search_albums=angular.copy($scope.albums),$routeParams.album_id){var current_user=$userStyle.getUser(!1);current_user||$userStyle.setUserAlbum($scope.albums[0].user),$userStyle.setBodyStyle(),$rootScope.share_album_id&&$rootScope.share_album_id==get_params.id||($rootScope.share_album_id=get_params.id,$scope.activeAlbum($scope.albums[0]))}})})},$scope.$on("$destroy",function(){$rootScope.current_album=null,$userStyle.setBodyStyle()}),$scope.$on("handleBroadcast",function(){log("listen broad cast on player page");var broadcast_data=fSharedService.message.data;switch(fSharedService.message.cmd){case"load-songs-done":var album_id=broadcast_data.album_id;angular.isDefined($scope.share_album_id)&&$scope.share_album_id==album_id&&(log("let play it"),$scope.share_album_id=null,fSharedService.prepForBroadcast({cmd:"play-songs",data:broadcast_data}))}}),$scope.activeAlbum=function(album){$rootScope.current_album=album,$scope.select_album_id=$rootScope.current_album._id,$userStyle.setBodyStyle()},$scope.showAddModel=function(){$scope.resetValue(),$scope.show_form=!0,log("weird",$scope.is_edit_album)},$scope.initTag=function(){$timeout(function(){$("#album-tags").tagsInput({width:"auto",height:50})},100)},$scope.removeAlbum=function(remove_album){var title="Are you sure to remove the album: "+remove_album.title;$dialogs.confirm(title,function(){Albums.remove({id:remove_album._id},function(res){$scope.processRetrieveData(res,function(){$scope.removeItemInList($scope.albums,remove_album._id),$scope.removeItemInList($scope.search_albums,remove_album._id),$rootScope.current_album&&$rootScope.current_album._id==remove_album._id&&($scope.select_album_id=null,$rootScope.current_album=null)})})})},$scope.shareAlbum=function(album){var title="After you share this album, other user can browse this album and listen to, Do you want to continue ?";$dialogs.confirm(title,function(){Albums.update({action:"share"},album,function(res){$scope.processRetrieveData(res,function(data){$dialogs.success("Your album is shared to public, You can unshare it whenever you want"),$scope.updateItemInList($scope.albums,data),$scope.updateItemInList($scope.search_albums,data)})})})},$scope.unShareAlbum=function(album){Albums.update({action:"unshare"},album,function(res){$scope.processRetrieveData(res,function(data){$scope.updateItemInList($scope.albums,data),$dialogs.success("Your album is unshared")})})},$scope.showPublicLink=function(album){$scope.show_public_link=!0,log($scope.show_public_link),$scope.share_album=album,$scope.public_link=document.location.origin+"/album/"+album.slug},$scope.resetValue=function(){$scope.show_form=!1,$scope.album_title="",$scope.album_cover="",$scope.album_tags="",$scope.album_description="",$scope.album_wallpaper="",$scope.is_edit_album=null},$scope.setTagFilter=function(tag_name){tag_name=tag_name.replace(" ","-"),$scope.filter_album="#"+tag_name,$scope.user||($scope.filter_album+=" ~public"),$scope.doSearch()},$scope.setUserFilter=function(user_name){$scope.filter_album="@"+user_name,$scope.doSearch()},$scope.submitAlbum=function(){log("submit album");var post_data={title:$scope.album_title,cover:$scope.album_cover,description:$scope.album_description,wallpaper_url:$scope.album_wallpaper,tags:$("#album-tags").val()};log("post_data",post_data),$scope.is_edit_album?$scope.doEditAlbum(post_data):$scope.doAddAlbum(post_data)},$scope.doAddAlbum=function(post_data){$scope.pending_add_album=!0,Albums.post({},post_data,function(res){$scope.pending_add_album=!1,$scope.processRetrieveData(res,function(data){$scope.albums.push(data),$scope.isMatch(data,$scope.search_result)&&$scope.search_albums.push(angular.copy(data)),$dialogs.success("You added new album"),$scope.resetValue()})})},$scope.editAlbum=function(edit_album){$scope.show_form=!0,$scope.is_edit_album=!0,$scope.album_title=edit_album.title,$scope.edit_album=angular.copy(edit_album),$scope.album_tags=_.map(edit_album.tags,function(tag){return tag.name}),$scope.album_description=edit_album.description,$scope.album_wallpaper=edit_album.wallpaper_url},$scope.doEditAlbum=function(post_data){log("post_data in editAlbum",post_data);var copy_album=angular.copy($scope.edit_album);$scope.pending_edit_album=!0,copy_album=_.extend(copy_album,post_data),log("copy_album",copy_album),Albums.update({},copy_album,function(res){$scope.pending_edit_album=!1,$scope.processRetrieveData(res,function(data){$scope.updateItemInList($scope.albums,data),$scope.updateItemInList($scope.search_albums,data),$dialogs.success("The album is updated"),log($scope.albums),$scope.resetValue(),$rootScope.current_album&&$rootScope.current_album._id==data._id&&($rootScope.current_album=data,$userStyle.setBodyStyle())})})},$scope.doSearch=function(){log("filter_album",$scope.filter_album),$scope.parseSearch($scope.filter_album,function(result){log("result is ",result),result.search_online?$scope.filterOnline(result):$scope.filterOffline(result)})},$scope.filterOnline=function(search_result){$scope.do_searching_online=!0;var query_data=angular.copy(search_result);query_data.tail="search",Albums.get(query_data,search_result,function(res){$scope.do_searching_online=!1,$scope.processRetrieveData(res,function(albums){$scope.search_albums=albums})})},$scope.filterOffline=function(result){if($scope.search_result=result,""==result.full||null==result.full)return log("nothing to search"),$scope.search_albums=angular.copy($scope.albums);for(var temp_albums=[],i=0;i<$scope.albums.length;i++){log("llop");var album=$scope.albums[i];$scope.isMatch(album,result)&&temp_albums.push(angular.copy(album))}$scope.search_albums=temp_albums},$scope.isMatch=function(album,search_result){if(!angular.isDefined(search_result))return!0;if(search_result.keyword&&-1==album.search_title.toLowerCase().search(search_result.keyword))return!1;if(search_result.tag){var j=0;for(j=0;j<album.tags.length&&-1==album.tags[j].search_title.toLowerCase().search(search_result.tag);j++);if(j==album.tags.length)return!1}return!0},$scope.isOwn=function(user_id){return $scope.user?$scope.user._id==user_id:!1},$scope.parseSearch=function(keyword,callback){if(keyword=$.trim(angular.copy(keyword)),$scope.is_searching||$scope.do_searching_online)return void log("ignore");var public_indicator="~public",result={keyword:null,tag:null,user:null,is_public:!1,full:keyword};if(""==keyword)return log("Stop here"),callback(keyword);-1!=keyword.search(public_indicator)&&(result.is_public=!0,keyword=keyword.replace(public_indicator,""));var regex=keyword.match(/@[\w]*/i);if(regex){log("res",regex),keyword=keyword.substr(0,regex.index-1)+keyword.substr(regex.index+regex[0].length);var search_user=regex[0].substr(1);""!=search_user&&(result.user=search_user)}if(regex=keyword.match(/#[\w,\-,\_,á,à,ả,ã,ạ,ă,ắ,ằ,ẳ,ẵ,ặ,â,ầ,ầ,ẩ,ẫ,ậ,é,è,ẻ,ẽ,ẹ,ê,ế,ề,ể,ễ,ệ,í,ì,ỉ,ĩ,ị,ó,ò,ỏ,õ,ọ,ô,ố,ồ,ổ,ỗ,ộ,ơ,ớ,ờ,ở,ỡ,ợ,ú,ù,ủ,ũ,ụ,ư,ứ,ừ,ử,ữ,ự]*/i),regex&&(result.tag=regex[0].substr(1).toLowerCase(),result.tag=removeUnicode($.trim(result.tag).toLowerCase()),result.tag=result.tag.replace("-"," "),keyword=keyword.substr(0,regex.index-1)+keyword.substr(regex.index+regex[0].length)),result.keyword=removeUnicode($.trim(keyword).toLowerCase()),log("result is",result),null!=result.user){if(!$scope.user||$scope.user&&result.user!=$scope.user.user_name)return result.is_public=!0,result.search_online=!0,log("search public"),callback(result);result.search_online=!1,log("Search local1"),callback(result)}else{if(result.is_public)return result.search_online=!0,log("search public"),callback(result);result.search_online=!1,callback(result),log("Search local")}}});
var linkApp=angular.module("linkApp",[]);linkApp.config(["$routeProvider",function($routeProvider){$routeProvider.when("/links",{templateUrl:templateVersion("frontend/js/link/link.html"),controller:"LinkCtrl"})}]),linkApp.factory("Links",["$resource","$cookies",function($resource){return $resource("links/:tail",{},{query:{method:"GET"},post:{method:"POST",headers:{"x-csrf-token":csrf}},update:{method:"PUT",headers:{"x-csrf-token":csrf}},remove:{method:"DELETE",headers:{"x-csrf-token":csrf}}})}]),linkApp.controller("LinkCtrl",function($scope,$http,$location,$window,$dialogs,$rootScope,Links,$timeout,$routeParams,Page){$scope.init=function(){$scope.pending_add_link=!1,$scope.resetValue(),$scope.albums=null,$scope.select_album_id=null,$scope.type=$routeParams.type;var get_params={};$routeParams.album_id&&($scope.share_album_id=$routeParams.album_id,get_params.id=$routeParams.album_id),$scope.navigation_name="link",Page.setTitle("Bookmark your favorite links"),Links.get(get_params,function(res){$scope.processRetrieveData(res,function(data){$scope.links=data})})},$scope.showAddModel=function(){$scope.resetValue(),$scope.show_link_form=!0},$scope.deleteLink=function(remove_link){var title="Are you sure to delete the link: "+remove_link.title;$dialogs.confirm(title,function(){Links.remove({id:remove_link._id},function(res){$scope.processRetrieveData(res,function(){$scope.removeItemInList($scope.links,remove_link._id)})})})},$scope.resetValue=function(){$scope.show_link_form=!1,$scope.link_title="",$scope.link_url="",$scope.is_edit_link=null},$scope.submitLink=function(){log("submit link");var post_data={title:$scope.link_title,url:$scope.link_url};log("post_data",post_data),$scope.is_edit_link?$scope.doEditLink(post_data):$scope.doAddLink(post_data)},$scope.doAddLink=function(post_data){$scope.pending_add_link=!0,Links.post({},post_data,function(res){$scope.pending_add_link=!1,$scope.processRetrieveData(res,function(data){$scope.links.push(data),$dialogs.success("You added new link successfully"),$scope.resetValue()})})},$scope.editLink=function(edit_link){$scope.show_link_form=!0,$scope.is_edit_link=!0,$scope.link_title=edit_link.title,$scope.link_url=edit_link.url,$scope.edit_link=angular.copy(edit_link)},$scope.doEditLink=function(post_data){log("post_data in editLink",post_data);var copy_link=angular.copy($scope.edit_link);$scope.pending_edit_link=!0,copy_link=_.extend(copy_link,post_data),log("copy_link",copy_link),Links.update({},copy_link,function(res){$scope.pending_edit_link=!1,$scope.processRetrieveData(res,function(data){$scope.updateItemInList($scope.links,data),$dialogs.success("The link is updated"),$scope.resetValue()})})}});
var playerApp=angular.module("playerApp",[]);playerApp.controller("PlayerCtrl",function($scope,$rootScope,$http,$location,$window,$dialogs,$timeout,fSharedService){$scope.range_style={width:"80%"},$scope.song_index=0,$scope.show_list=!1,$scope.current_audio=null,$scope.songs=[],$scope.escape=function(str){return str.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,""),str},$scope.$on("handleBroadcast",function(){log("listen broad cast on player page");var broadcast_data=fSharedService.message.data;switch(fSharedService.message.cmd){case"play-songs":if($scope.songs=broadcast_data.songs,$scope.song_index=broadcast_data.index,$scope.song_index>=$scope.songs.length)return;log("broadcast_data",broadcast_data),$scope.album_cover_id=broadcast_data.album_cover_id?broadcast_data.album_cover_id:null,$scope.initPlayer();break;case"add-to-queue":for(var song=broadcast_data,i=0;i<$scope.songs.length;i++)if(log("songs",$scope.songs),$scope.songs[i]._id==song._id)return $dialogs.message("This song has already in the playlist");$scope.songs.push(song),1==$scope.songs.length&&($scope.song_index=0,$scope.initPlayer())}}),$scope.initPlayer=function(){if($("body").addClass("show-playlist"),angular.isDefined($scope.audio))$scope.setSong();else{var as=audiojs.createAll($scope.audiojs_setting);$scope.audio=as[0],$timeout(function(){$scope.setSong()})}},$scope.changeVolume=function(event){var instance=$(event.target);instance.hasClass("wrap-range")||(instance=instance.parent());var parentOffset=instance.offset(),relX=event.pageX-parentOffset.left;console.log(relX),console.log(instance);var percent=relX/instance.width();console.log(percent),$scope.range_style.width=relX+"%",$scope.audio.setVolume(percent),$dialogs.message("Current volume is "+Math.round(100*percent)+"%")},$scope.animateLogo=function(){$(".player-zone img.cover").length>0&&$("#logo img").length>0?$scope.doAnimateLogo():$timeout(function(){$scope.doAnimateLogo()},500)},$scope.doAnimateLogo=function(){$(".player-zone img.cover").removeClass("playing"),$("#logo img").addClass("animated").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("animated"),$(".player-zone img.cover").addClass("playing")})},$scope.init=function(){$rootScope.playing_song=$scope.songs[$scope.song_index],$scope.album_cover_id=null,$scope.audiojs_setting={callbackError:function(error){console.log(error),console.clear();$dialogs.error(error);$timeout(function(){$(".player-zone img.cover").removeClass("playing")},1e3)},callbackPlay:function(){console.log("callbackPlay"),$scope.animateLogo()},callbackPause:function(){console.log("stop"),$(".player-zone img.cover").removeClass("playing")},trackEnded:function(){$scope.$apply(function(){$scope.next()})}}},$scope.prev=function(){log("prev"),$scope.song_index--,$scope.setSong()},$scope.removeOld=function(){$(".scrubber").remove(),$(".played").remove(),$(".duration").remove()},$scope.removeError=function(){$(".audiojs").hasClass("error")&&$(".audiojs").removeClass("error")},$scope.next=function(){log($scope.audio),$scope.audio.element.pause(),log("next"),$scope.song_index++,$scope.song_index=$scope.song_index>=$scope.songs.length?0:$scope.song_index,$scope.setSong()},$scope.setSong=function(index){if($scope.animateLogo(),$scope.song_index==typeof index!="undefined"?index:$scope.song_index,$rootScope.playing_song=$scope.songs[$scope.song_index],$scope.removeError(),$scope.audio.load($rootScope.playing_song.link),$dialogs.dismissAll(),$rootScope.playing_song.emotion&&$rootScope.playing_song.emotion.length>0){var message="<strong>{0}</strong>: {1}".format($rootScope.playing_song.title,$rootScope.playing_song.emotion);$dialogs.message(message,0)}$timeout(function(){$scope.audio.play()},100)},$scope.playSong=function(index){log("how",index),$scope.song_index=index,$scope.setSong()}});
var songApp=angular.module("songApp",["html5.sortable"]);songApp.factory("Songs",["$resource","$cookies",function($resource){return $resource("songs",{},{query:{method:"GET"},post:{method:"POST",headers:{"x-csrf-token":csrf}},update:{method:"PUT",headers:{"x-csrf-token":csrf}},remove:{method:"DELETE",headers:{"x-csrf-token":csrf}}})}]),songApp.controller("SongCtrl",function($scope,$http,$location,$window,$dialogs,Songs,fSharedService){$scope.songs=null,$scope.loading_songs=!1,$scope.song_predicate=["-position"],$scope.show_multi_song_help=!1,$scope.$watch("select_album_id",function(){$scope.select_album_id?($scope.loading_songs=!0,Songs.get({album_id:$scope.select_album_id},function(res){$scope.loading_songs=!1,$scope.processRetrieveData(res,function(data){data=_.sortBy(data,function(song){return song.position}),$scope.songs=data;var broadcast_data={album_id:$scope.select_album_id,index:0,songs:angular.copy($scope.songs)};$scope.current_album.feature_id&&(broadcast_data.album_cover_id=$scope.current_album.feature_id),fSharedService.prepForBroadcast({cmd:"load-songs-done",data:broadcast_data})})})):$scope.songs=null,log("current_album is changed",$scope.select_album_id)},!0),$scope.addSong=function(){$scope.resetValue(),$scope.show_song_form=!0},$scope.addMultiSong=function(){$scope.show_multi_song_form=!0},$scope.resetValue=function(){$scope.song_title="",$scope.song_link="",$scope.song_emotion="",$scope.is_edit_song=!1},$scope.sortable_songs={handle:".handle",stop:function(list,dropped_index){log("list after sort is ",list);var first_song=list[0];if($scope.isOwn(first_song.user_id)){log("update data to server");for(var arr_post_update=(list[dropped_index],[]),i=0;i<list.length;i++){var song=list[i];song.position=i,arr_post_update.push({_id:song._id,title:song.title,position:song.position})}log(arr_post_update),Songs.update({action:"sort_songs"},arr_post_update,function(res){$scope.processRetrieveData(res,function(){})})}else log("only local")}},$scope.submitSong=function(){var song_item={title:$scope.song_title,link:$scope.song_link,emotion:$scope.song_emotion},post_data={list:[song_item],album_id:$scope.select_album_id};return log("post_data",post_data),$scope.is_edit_song?$scope.doUpdateSong(post_data):($scope.pending_add_song=!0,void Songs.post({},post_data,function(res){$scope.pending_add_song=!1,$scope.processRetrieveData(res,function(data){$scope.songs=$scope.songs.concat(data.songs),$dialogs.success(1==data.songs.length?"You added new song":"You added {0} songs".format(data.songs.length)),$scope.updateScopeObject($scope.current_album,data.album),$scope.resetValue()})}))},$scope.submitMultiSong=function(){try{var post_data={list:JSON.parse($scope.list_add_song),album_id:$scope.select_album_id};log(post_data),$scope.pending_add_multi_song=!0,Songs.post({},post_data,function(res){$scope.pending_add_multi_song=!1,$scope.processRetrieveData(res,function(data){$scope.songs=$scope.songs.concat(data.songs);var message="You added {0} songs".format(data.songs.length);data.duplicated_songs>0&&(message+=" and there are {0} song are duplicated the link".format(data.duplicated_songs)),$dialogs.success(message),$scope.updateScopeObject($scope.current_album,data.album),$scope.show_multi_song_form=!1,$scope.list_add_song="",$scope.resetValue()})})}catch(e){log(e),$dialogs.error("Please check your json format, it's not valid")}},$scope.doUpdateSong=function(update_song_data){log("update_song_data",update_song_data);var copy_song=angular.copy($scope.edit_song);$scope.pending_edit_song=!0,copy_song=_.extend(copy_song,update_song_data),log("copy_song",copy_song),Songs.update({},copy_song,function(res){$scope.pending_edit_song=!1,$scope.processRetrieveData(res,function(data){$scope.updateItemInList($scope.songs,data),$scope.show_song_form=!1,$dialogs.success("The song is updated"),$scope.resetValue()})})},$scope.editSong=function(song){log("editSong song",song),$scope.is_edit_song=!0,$scope.edit_song=angular.copy(song),$scope.song_title=song.title,$scope.song_link=song.link,$scope.song_emotion=song.emotion,$scope.show_song_form=!0},$scope.deleteSong=function(song){var title="Are you sure to remove the song: "+song.title;$dialogs.confirm(title,function(){Songs.remove({id:song._id},function(res){$scope.processRetrieveData(res,function(data){$scope.updateScopeObject($scope.current_album,data),$scope.removeItemInList($scope.songs,song._id)})})})},$scope.isPlaying=function(song){return angular.isDefined($scope.playing_song)&&$scope.playing_song._id==song._id},$scope.playSong=function(song_index){log("song_index",song_index);var broadcast_data={index:song_index,songs:angular.copy($scope.songs)};broadcast_data.album_cover_id=$scope.current_album.feature_id,log("pre data",broadcast_data),fSharedService.prepForBroadcast({cmd:"play-songs",data:broadcast_data})},$scope.showEmotion=function(song){$dialogs.dismissAll();var message="<strong>{0}</strong>: {1}".format(song.title,song.emotion);$dialogs.message(message,0)},$scope.addToQueue=function(song){fSharedService.prepForBroadcast({cmd:"add-to-queue",data:song})},$scope.downloadSong=function(song){var pom=document.createElement("a");pom.setAttribute("href",song.link),pom.setAttribute("download",song.title),pom.click(),$dialogs.success("The song is in the download progress")}});
var navigationApp=angular.module("navigationApp",[]);navigationApp.controller("NavigationCtrl",function($scope){$scope.init=function(current_page){$scope.current_page=current_page}});
var headerApp=angular.module("headerApp",[]);headerApp.controller("HeaderCtrl",function($scope,Users,$rootScope,$cookieStore,$userStyle){$scope.init=function(current_page){$scope.current_page=current_page,angular.isDefined($rootScope.user)||Users.get({tail:"info"},function(res){if(log(res),"ok"==res.status){var user=res.data;$cookieStore.put("user",user),$rootScope.user=user,$userStyle.setBodyStyle()}})}});